% Add \MyTitle, \MyAuthor and \MyDate
\RequirePackage{authoraftertitle}

\RequirePackage{etoolbox}

% Add ACM colors
\RequirePackage[dvipsnames]{xcolor}
\definecolor[named]{ACMBlue}{cmyk}{1,0.1,0,0.1}
\definecolor[named]{ACMYellow}{cmyk}{0,0.16,1,0}
\definecolor[named]{ACMOrange}{cmyk}{0,0.42,1,0.01}
\definecolor[named]{ACMRed}{cmyk}{0,0.90,0.86,0}
\definecolor[named]{ACMLightBlue}{cmyk}{0.49,0.01,0,0}
\definecolor[named]{ACMGreen}{cmyk}{0.20,0,1,0.19}
\definecolor[named]{ACMPurple}{cmyk}{0.55,1,0,0.15}
\definecolor[named]{ACMDarkBlue}{cmyk}{1,0.58,0,0.21}

% Use inconsolata for monospace font
\RequirePackage{inconsolata}

% Hyperref settings
\RequirePackage[unicode, breaklinks=true]{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=ACMPurple,
    urlcolor=ACMBlue,
    citecolor=ACMPurple,
}
\urlstyle{same}

% Add \cref and \Cref
\usepackage{cleveref}
\crefname{lstlisting}{listing}{listings}
\Crefname{lstlisting}{Listing}{Listings}

% Add \enquote
\usepackage{csquotes}

% Add epigraphs for chapters with \epigraph
\usepackage{epigraph}
\setlength\epigraphwidth{.6\textwidth}
\renewcommand{\epigraphsize}{\small\itshape}

% Better enumerations
\usepackage[shortlabels,inline]{enumitem}
\setlist[enumerate]{
  leftmargin=*
}

% Code listings
\RequirePackage{listings}

\lstnewenvironment{listing}[1][]{\lstset{#1}}{}

\definecolor{listing-background}{HTML}{F7F7F7}
\definecolor{listing-rule}{HTML}{B3B2B3}
\definecolor{listing-numbers}{HTML}{B3B2B3}
\definecolor{listing-text-color}{HTML}{000000}
\definecolor{listing-keyword}{HTML}{435489}
\definecolor{listing-keyword-2}{HTML}{1284CA} % additional keywords
\definecolor{listing-keyword-3}{HTML}{9137CB} % additional keywords
\definecolor{listing-identifier}{HTML}{435489}
\definecolor{listing-string}{HTML}{00999A}
\definecolor{listing-comment}{HTML}{8E8E8E}

% Define "none" language for listings
\lstdefinelanguage{none}{
  identifierstyle=
}

% Define "diff" language for listings
\definecolor{diffstart}{named}{Gray}
\definecolor{diffincl}{named}{Green}
\definecolor{diffrem}{named}{OrangeRed}
\lstdefinelanguage{diff}{
    basicstyle=\ttfamily\small,
    morecomment=[f][\color{diffstart}]{@@},
    morecomment=[f][\color{diffincl}]{+},
    morecomment=[f][\color{diffrem}]{-},
}

% yaml language for listings
\newcommand\YAMLkeystyle{\bfseries\color{listing-keyword-3}}
\newcommand\YAMLcolonstyle{\bfseries\color{listing-keyword-3}}
\newcommand\YAMLvaluestyle{\normalfont\ttfamily\color{listing-string}}
\lstdefinelanguage{yaml}{
  keywords={true,false,null,y,n},
  basicstyle = \YAMLkeystyle\ttfamily\normalsize\lst@ifdisplaystyle\footnotesize\singlespacing\fi,
  sensitive=false,
  comment=[l]{\#},
  morecomment=[s]{/*}{*/},
  stringstyle=\YAMLvaluestyle,
  moredelim=**[il][\YAMLcolonstyle{:}\YAMLvaluestyle]{:},   % switch to value style at :
  moredelim=**[l][\YAMLvaluestyle]{-},   % switch to value style at -
  morestring=[b]',
  morestring=[b]",
}

% Set default listings style
\lstdefinestyle{listing_style}{
    language         = none,
    %numbers          = left,
    %xleftmargin      = 3.7em,
    %framexleftmargin = 3.5em,
    xleftmargin      = 1em,
    framexleftmargin = 1em,
    xrightmargin      = 1em,
    framexrightmargin = 1em,
    backgroundcolor  = \color{listing-background},
    numberstyle      = \color{listing-numbers}\ttfamily\normalsize\lst@ifdisplaystyle\footnotesize\fi,
    basicstyle       = \ttfamily\normalsize\lst@ifdisplaystyle\footnotesize\singlespacing\fi,
    breaklines       = true,
    frame            = single,
    framesep         = 0.19em,
    rulecolor        = \color{listing-rule},
    frameround       = ffff,
    tabsize          = 4,
    aboveskip        = 0.5em,
    belowskip        = 0.5em,
    abovecaptionskip = 0em,
    belowcaptionskip = 0.5em,
    keywordstyle     = {\color{listing-keyword}\bfseries},
    keywordstyle     = {[2]\color{listing-keyword-2}\bfseries},
    keywordstyle     = {[3]\color{listing-keyword-3}\bfseries\itshape},
    sensitive        = true,
    commentstyle     = \color{listing-comment},
    stringstyle      = \color{listing-string},
    showstringspaces = false,
    escapeinside     = {/*@}{@*/}, % Allow LaTeX inside these special comments
    literate         =
    {á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1
    {Á}{{\'A}}1 {É}{{\'E}}1 {Í}{{\'I}}1 {Ó}{{\'O}}1 {Ú}{{\'U}}1
    {à}{{\`a}}1 {è}{{\'e}}1 {ì}{{\`i}}1 {ò}{{\`o}}1 {ù}{{\`u}}1
    {À}{{\`A}}1 {È}{{\'E}}1 {Ì}{{\`I}}1 {Ò}{{\`O}}1 {Ù}{{\`U}}1
    {ä}{{\"a}}1 {ë}{{\"e}}1 {ï}{{\"i}}1 {ö}{{\"o}}1 {ü}{{\"u}}1
    {Ä}{{\"A}}1 {Ë}{{\"E}}1 {Ï}{{\"I}}1 {Ö}{{\"O}}1 {Ü}{{\"U}}1
    {â}{{\^a}}1 {ê}{{\^e}}1 {î}{{\^i}}1 {ô}{{\^o}}1 {û}{{\^u}}1
    {Â}{{\^A}}1 {Ê}{{\^E}}1 {Î}{{\^I}}1 {Ô}{{\^O}}1 {Û}{{\^U}}1
    {œ}{{\oe}}1 {Œ}{{\OE}}1 {æ}{{\ae}}1 {Æ}{{\AE}}1 {ß}{{\ss}}1
    {ç}{{\c c}}1 {Ç}{{\c C}}1 {ø}{{\o}}1 {å}{{\r a}}1 {Å}{{\r A}}1
    {€}{{\EUR}}1 {£}{{\pounds}}1 {«}{{\guillemotleft}}1
    {»}{{\guillemotright}}1 {ñ}{{\~n}}1 {Ñ}{{\~N}}1 {¿}{{?`}}1
    {…}{{\ldots}}1 {≥}{{>=}}1 {≤}{{<=}}1 {„}{{\glqq}}1 {“}{{\grqq}}1
    {”}{{''}}1 {~}{$\sim$}{1}
}
\lstset{style=listing_style}

% Set fancy headers and footers
\RequirePackage{fancyhdr}
\RequirePackage{ifthen}
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0.1pt}
\renewcommand{\footrulewidth}{0pt}
\fancyhead{}   % clear all headers
\fancyfoot{}   % clear all footers
\fancyfoot[C]{\small\thepage}
\fancyhead[L]{\nouppercase\MyTitle} % book title
\fancyhead[R]{\nouppercase\MyAuthor} % author name

\setlength{\headheight}{1.3em}

% Set table of contents depth to 3
\setcounter{tocdepth}{3}

% Add \onehalfspacing
\RequirePackage{setspace}

% Floats and tables
\RequirePackage{booktabs}
\RequirePackage{multirow}
\RequirePackage{rotating}
\RequirePackage{adjustbox}
\RequirePackage{array}
\RequirePackage{longtable}

\AtBeginEnvironment{longtable}{\singlespacing\centering}

\newcolumntype{R}[2]{%
    >{\adjustbox{angle=#1,lap=\width-(#2)}\bgroup}%
    l%
    <{\egroup}%
}
\newcommand*\rot{\multicolumn{1}{R{45}{1em}}}%

\RequirePackage{wasysym}
\newcommand{\fullc}{\CIRCLE}
\newcommand{\halfc}{\LEFTcircle}
\newcommand{\emptyc}{\Circle}

% Center floats by default
\makeatletter
\g@addto@macro\@floatboxreset{\centering}
\makeatother

% Graphicx for figures
\RequirePackage{graphicx}

\RequirePackage{placeins}

% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
%\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
%\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
%\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% Format captions
\RequirePackage[bf,font={small,stretch=1},margin=1cm]{caption}

% Reposition captions automatically
\RequirePackage{floatrow}
\floatsetup[figure]{capposition=bottom}
\floatsetup[listing]{capposition=top}
\floatsetup[table]{capposition=top}

% Default to intelligent float placement
\floatplacement{figure}{htbp!}
\floatplacement{table}{htbp!}

% Subcounters for figures and tables
\RequirePackage{chngcntr}
\counterwithin{figure}{section}
\counterwithin{table}{section}
\AtBeginDocument
{
  \counterwithin{lstlisting}{section}
}

% Numbers for paragraphs
\setcounter{secnumdepth}{4}

\RequirePackage{titlesec}
\titlespacing{\paragraph}{0pt}{1em}{1em}
\titlespacing{\subparagraph}{\parskip}{0pt}{1em}
\titleformat*{\subparagraph}{\itshape}

% biblatex
\RequirePackage[backend=biber, style=ieee, citestyle=numeric, sortcites=true, maxbibnames=9999, minbibnames=1, sorting=nyt, dashed=false, giveninits=false]{biblatex}

% Magic to stop overfull hbox in bibliography!
\patchcmd{\bibsetup}{\interlinepenalty=5000}{\interlinepenalty=10000}{}{}
\emergencystretch=1em

% Commands
\providecommand{\todo}[1]{{\bfseries\color{ACMRed}[#1]}}
\providecommand{\etal}{{\itshape et al.}~}
